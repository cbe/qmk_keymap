/*
Copyright 2025 @cbe

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include QMK_KEYBOARD_H

#ifdef OLED_ENABLE
    // Keep track of the current default layer
    int default_layer = _BASE_HD;
    void track_default_layer(void) {
        uint32_t layer_state = default_layer_state;

        // Check which layer is active
        if (layer_state & (1UL << _BASE_HD)) {
            default_layer = _BASE_HD;
        } else if (layer_state & (1UL << _BASE_QW)) {
            default_layer = _BASE_QW;
        }
    }

    void matrix_scan_user(void) {
        track_default_layer();
    }

    static void render_image(void) {
        static const char PROGMEM boba_fett[] = {
            0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xF1, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xF9, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F,
            0x7F, 0x7F, 0x7F, 0x7F, 0x3F, 0x3F,
            0x3F, 0x3F, 0x1F, 0x1F, 0x7F, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0x00, 0xDB, 0xDB, 0xDB,
            0x5B, 0xFF, 0xFF, 0xFF, 0xFF, 0x9B,
            0xC3, 0xDF, 0xFF, 0x5F, 0xFF, 0xBD,
            0xFC, 0xDE, 0xFF, 0xFD, 0xFF, 0xFF,
            0xFF, 0x6F, 0x7F, 0x7F, 0x7F, 0x7F,
            0x7F, 0x7F, 0x7F, 0x7F, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFD,
            0xFF, 0xFB, 0xE1, 0xE1, 0xC1, 0x80,
            0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF,
            0xFF, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F,
            0x7F, 0x7F, 0xFF, 0xFF, 0xDF, 0xCF,
            0xCF, 0x1F, 0x1F, 0x0B, 0x03, 0x63,
            0x23, 0x23, 0x23, 0x23, 0x61, 0x41,
            0x41, 0xE0, 0xF0, 0xF8, 0xF0, 0xF0,
            0xF0, 0xF0, 0x60, 0x60, 0x60, 0x30,
            0x30, 0xD8, 0xEC, 0xFC, 0xF0, 0x60,
            0xC0, 0x81, 0x07, 0x7F, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFD,
            0x7D, 0x7F, 0x7F, 0x7F, 0x3F, 0x1F,
            0xBF, 0xFF, 0xFF, 0xFF, 0xE0, 0xED,
            0xE0, 0xED, 0xEC, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFD, 0x3D, 0x1E, 0x1F, 0x9F,
            0xD7, 0x5F, 0x2F, 0x03, 0x61, 0xF8,
            0xB8, 0xF8, 0x78, 0x78, 0x78, 0xB8,
            0xB8, 0x90, 0x98, 0x98, 0xD8, 0xC8,
            0xCD, 0xC7, 0xCF, 0x83, 0x01, 0x01,
            0x00, 0x01, 0x00, 0x01, 0x01, 0x01,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
            0xC1, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0xF9,
            0xF9, 0xF8, 0xFC, 0xFC, 0xFC, 0xFC,
            0xFC, 0xFC, 0xFC, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0x7F, 0x10, 0x00, 0x80,
            0xD8, 0xFC, 0xFC, 0x40, 0x60, 0x70,
            0xF0, 0xBE, 0x03, 0x3B, 0x93, 0xC3,
            0x81, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x48, 0xDA, 0xDF, 0xEF, 0xFD,
            0xFF, 0x00, 0x00, 0x01, 0x02, 0x0C,
            0x3F, 0xFF, 0xFF, 0xFF, 0x3F, 0x3D,
            0x1E, 0x1C, 0x00, 0x00, 0x00, 0x00,
            0x00, 0xF3, 0xFB, 0xF9, 0x7D, 0x3F,
            0x1F, 0x0F, 0x0F, 0x13, 0x89, 0xCF,
            0xE3, 0xE1, 0xF1, 0xF0, 0xF8, 0xF8,
            0xFC, 0xFC, 0xFE, 0x7E, 0x0E, 0x02,
            0x01, 0x81, 0xA0, 0xFE, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xEF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
            0xFF, 0xFF, 0xFD, 0xFD, 0xFD, 0xFC,
            0xF4, 0xFC, 0xF9, 0xFF, 0xF0, 0xF0,
            0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0,
            0x00, 0x37, 0x33, 0x0B, 0x01, 0x01,
            0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFC,
            0xFE, 0xFF, 0x3F, 0x07, 0x01, 0x00,
            0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
            0x06, 0x00, 0x07, 0xFF, 0xE8, 0x00,
            0x00, 0x03, 0x07, 0x0F, 0x1F, 0x3E,
            0x3C, 0x7C, 0xB8, 0x77, 0x1F, 0x1F,
            0x1F, 0x1F, 0x09, 0x08, 0x08, 0x08,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x0B,
            0x88, 0x00, 0x00, 0x00, 0x00, 0xE0,
            0x02, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x30, 0x78, 0x7C, 0x7E, 0x3F, 0x1F,
            0x9F, 0xCF, 0xC7, 0xE7, 0xE3, 0xE3,
            0xE1, 0xF1, 0xF0, 0xF8, 0xE0, 0x00,
            0x00, 0x01, 0x01, 0x03, 0x07, 0x07,
            0x0F, 0x0F, 0x0F, 0x07, 0x0F, 0x07,
            0x07, 0x07, 0x07, 0x07, 0x07, 0x03,
            0x03, 0x03, 0x03, 0x01, 0x01, 0x01,
            0x01, 0x81, 0x80, 0x81, 0xC1, 0xC0,
            0xC0, 0x60, 0x60, 0x20, 0x20, 0x30,
            0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00,
        };

        oled_write_raw_P((boba_fett), sizeof(boba_fett));
    };

    bool oled_task_user() {
        if (is_keyboard_master()) {
            // Left screen
            // Operating system
            oled_write("OS: ", false);
            const os_variant_t detected_os = detected_host_os();
            switch (detected_os) {
                case OS_LINUX:
                    oled_write("Linux", false);
                    break;
                case OS_MACOS:
                    oled_write("MacOS", false);
                    break;
                case OS_WINDOWS:
                    oled_write("Windows", false);
                    break;
                case OS_IOS:
                    oled_write("iOS", false);
                    break;
                case OS_UNSURE:
                    oled_write("Unknown", false);
                    break;
            }
            oled_advance_page(true);

            // Layer
            oled_write("Layer: ", false);
            if (get_highest_layer(layer_state) <= _BASE_QW) {
                switch (default_layer) {
                    case _BASE_HD:
                        oled_write("base [rsnt]", false);
                        break;
                    case _BASE_QW:
                        oled_write("base [asdf]", false);
                        break;
                }
            } else {
                switch (get_highest_layer(layer_state)) {
                    case _BASE_HD:
                    case _BASE_QW:
                        // Do nothing as it has to be handled differently, see `track_default_layer`
                        break;
                    case _NUM:
                        oled_write("numbers", false);
                        break;
                    case _NAV:
                        oled_write("navigation", false);
                        break;
                    case _SYM:
                        oled_write("symbols", false);
                        break;
                    case _MED:
                        oled_write("media", false);
                        break;
                    case _MOUSE:
                        oled_write("mouse", false);
                        break;
                    case _FN:
                        oled_write("function", false);
                        break;
                }
            }
            oled_advance_page(true);

            // Active modifiers
            uint8_t active_modifiers = get_mods() | get_oneshot_mods();
            oled_write("Modifier: ", false);
            if (!active_modifiers) {
                oled_write("-", false);
            }
            if (active_modifiers & MOD_MASK_GUI) {
                oled_write("G", false);
            }
            if (active_modifiers & MOD_MASK_ALT) {
                oled_write("A", false);
            }
            if (active_modifiers & MOD_MASK_CTRL) {
                oled_write("C", false);
            }
            if (active_modifiers & MOD_MASK_SHIFT) {
                oled_write("S", false);
            }
            oled_advance_page(true);

            // Caps word
            bool caps_word_state = is_caps_word_on();
            oled_write("Caps word: ", false);
            oled_write_P(caps_word_state ? PSTR("on") : PSTR("off"), false);
            oled_advance_page(true);
        } else {
            // Right screen
            render_image();
        }

        return false;
    }
#endif
